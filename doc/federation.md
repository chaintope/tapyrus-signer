# Federation Management

This document describes the Federation Management of Tapyrus.

## Overview

The Tapyrus Signer Network is a permitted network consisting of identifiable signers who can control to sign blocks.
These signers cannot only sign blocks but also can control the identity of the participants on the network themselves.
We introduce Federation, which is consisted of a set of identifiable signers and the features to maintain their access controls.

A new signer joining the network needs to get approval from the signers who belongs to the Federation.
Federation, including a new signer, needs to recreate a new Aggregate public key and secret in the same protocol as [How to set up new Tapyrus Signer Network](./setup.md).
The created Aggregate public key is committed by the signer in the existing Federation and submitted to Tapyrus Core with the block.
Block headers have a field for a new Aggregate public key.
When a new Aggregate public key is set in a block header, Tapyrus Core discards the public key that has been used so far and performs proof verification using the new Aggregate public key from the next block.
When leaving from the Federation, it is necessary to update the Aggregate public key in the same protocol.

## How To Update Federation

The following describes how to change the Federation.

### Re-create Aggregate public key and secret.

Federation members, including the new signer, regenerate the Aggregate public key and the secret in the same procedure as [Generate Aggregate public key and Node secret share for Tapyrus Signer network](./setup.md#generate-aggregate-public-key-and-node-secret-share-for-tapyrus-signer-network).
Note that the same node public key can be used for the existing signer, so Step 1 is not required. However, for a new signer, a key pair needs to be created in Step 1.

### Updating the Aggregate public key for existing signers

:heavy_exclamation_mark:Caution:
> Any Federation change requires that all federation members authorise it. To enforce this requirement a multi-party signature generated by all the signers is needed in every federation. Federation change is added to the block only when the signature is valid.
> In 0.4.0 release, you can set federation information in `federations.toml` file directly. If you want to update settings, you can update the `federations.toml` and restart tapyrus-signerd.

- Existing signers who belong to the Federation:
  - When a new signer is added, until the applicable block height is reached
    - MUST ignore any messages from the new signer.
  - after the block that applies the federation changes has been submitted into Tapyrus Core,
    - SHOULD disconnect the old signer who is no longer member of the Federation.
    - MUST reject any communication from them.
- New signer:
  - When the applicable block height is reached
    - MAY send a connection request to them.
- Old signer:
  - after the block that applies the federation changes has been submitted into Tapyrus Core,
    - SHOULD disconnect and leave from the Tapyrus Signer Network

### Start new signer and stop leaving signer

The new signer launches tapyrus-signer as described in [How To configure Tapyrus Signer Network](./configuration.md).
The signer MUST complete launching before entering the generation round of the specified block height.
When the signer leaves, they MAY stop the process at any time after the round where the new Federation is applied.

## Modify or rollback federation plan

The signers of the Federation can check the current and future federation configurations in their federations file.

Whenever there is a change in the planned Federation, you need to update the federations file in all the signers. All parameters in a Tapyrus network that are controlled by the federation are called XFields. They MAY be changed from time to time by the federation by setting the XField in the block header. All signers need to be involved in the signing of the xfield. This multi-party signature SHOULD be added to the federations file in all signers.

To cancel the planned Federation, edit the federations file. i.e remove the pending federation section. Then restart the signer node.

Federation changes or cancellations must be made before the previous block is generated and submitted to the blockchain.

## Sending XField to Tapyrus Core

The round master sends the new XField to Tapyrus Core one round before the new Federation is applied.
When starting the previous round, the round master sets a new XField in the block header and broadcast it to other members of the Federation.
Each member of the round, upon receiving the candidateblock message, compares that the XField in the candidateblock to the one expected in their federations file and verifies the signature. If the verification is successsful the signer signs the block.
If the verification failed, each member SHOULD ignored all messages during that round so that no blocks are generated in that round.
The block with XField becomes valid only if the number of signatures exceeds the threshold t among the existing signers of the Federation.

### Aggregate public key

Aggregated publey is a mandatory XField in every tapyrus network. The default aggregated pubkey is set in the block header of the genesis block.

### Maximum allowed block size

Tapyrus network uses a block size of 1MB by default. It can be increased by the federation using xfield max block size.
